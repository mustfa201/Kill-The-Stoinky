<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hit The Rat üêÄ ‚Äî No Assets</title>
<style>
  :root {
    --bg:#1f1f1f; --panel:#2b2b2b; --ink:#fff; --accent:#00e0ff; --danger:#ff4d6d;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:#111; color:var(--ink);
    display:grid; place-items:center; height:100vh; font-family:system-ui,Segoe UI,Arial;
  }
  .wrap{display:flex; flex-direction:column; gap:.75rem; align-items:center}
  canvas{
    background:linear-gradient(#3a3a3a,#333);
    border:3px solid #fff; border-radius:16px; display:block;
    box-shadow:0 10px 30px rgba(0,0,0,.4);
    cursor:crosshair;
    width:900px; height:540px; /* CSS size; JS will handle hi-DPI */
    max-width:95vw; height:auto; aspect-ratio:5/3;
  }
  .hud{
    display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;
    background:var(--panel); padding:.6rem .8rem; border-radius:12px;
    box-shadow:0 6px 16px rgba(0,0,0,.35);
  }
  .bar{
    width:260px; height:14px; background:#0007; border-radius:999px; overflow:hidden; border:1px solid #fff4;
  }
  .bar>i{display:block; height:100%; background:linear-gradient(90deg,#ff2f2f,#ff8a8a)}
  .label{opacity:.85; font-weight:600; letter-spacing:.2px}
  .weapons{
    display:flex; gap:.4rem; margin-left:.25rem;
    background:#0003; padding:.3rem; border-radius:10px;
  }
  .wbtn{
    border:none; padding:.45rem .6rem; border-radius:10px; font-size:16px;
    background:#0006; color:#fff; cursor:pointer; transition:transform .06s ease, background .2s;
    display:flex; align-items:center; gap:.4rem; user-select:none;
  }
  .wbtn:hover{transform:translateY(-1px)}
  .wbtn[data-active="true"]{outline:2px solid var(--accent); background:#013341}
  .right{margin-left:auto; display:flex; gap:.4rem}
  .pill{
    font-size:12px; padding:.2rem .5rem; border-radius:999px; background:#0005; border:1px solid #fff3
  }
  .reset{
    border:none; padding:.5rem .9rem; border-radius:10px; background:var(--danger); color:#fff; font-weight:700; cursor:pointer;
  }
  .toast{
    position:fixed; top:14px; left:50%; transform:translateX(-50%);
    background:#000b; border:1px solid #fff2; padding:.45rem .7rem; border-radius:10px; font-size:14px; opacity:.9
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="hud">
    <span class="label">Health</span>
    <div class="bar" aria-label="health"><i id="hpFill" style="width:100%"></i></div>
    <span id="hpText" class="pill">100 / 100</span>

    <div class="weapons" id="weapons">
      <button class="wbtn" data-tool="punch" data-active="true">üëä Punch</button>
      <button class="wbtn" data-tool="bat">üßº Soap</button>
      <button class="wbtn" data-tool="knife">üó°Ô∏è Knife</button>
      <button class="wbtn" data-tool="bomb">üí£ Bomb</button>
    </div>

    <div class="right">
      <span class="pill">Tip: drag to slice with üó°Ô∏è</span>
      <button id="reset" class="reset" title="Restart">Reset</button>
    </div>
  </div>

  <canvas id="c"></canvas>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
(() => {
  // ----- Canvas & DPI -----
  const cvs = document.getElementById('c');
  const ctx = cvs.getContext('2d');
  function resizeCanvas() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const {width:cssW, height:cssH} = cvs.getBoundingClientRect();
    cvs.width = Math.round(cssW * dpr);
    cvs.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  new ResizeObserver(resizeCanvas).observe(cvs);
  resizeCanvas();

  // ----- Game State -----
  const W = () => cvs.getBoundingClientRect().width;
  const H = () => cvs.getBoundingClientRect().height;

  const rat = {
    x: 0, y: 0, vx: 0, vy: 0, r: 48, rot: 0, rotV: 0,
    hpMax: 100, hp: 100, hurt: 0,
  };
  function centerRat() {
    rat.x = W()*0.55; rat.y = H()*0.65;
    rat.vx = rat.vy = 0; rat.rot = 0; rat.rotV = 0; rat.hp = rat.hpMax; rat.hurt = 0;
    screenShake = 0;
    bombs.length = particles.length = numbers.length = slashes.length = 0;
    updateHUD();
  }
  window.addEventListener('resize', () => { centerRat(); });

  // ----- HUD -----
  const hpFill = document.getElementById('hpFill');
  const hpText = document.getElementById('hpText');
  function updateHUD() {
    const pct = Math.max(0, rat.hp) / rat.hpMax;
    hpFill.style.width = `${Math.round(pct*100)}%`;
    hpText.textContent = `${Math.max(0, Math.round(rat.hp))} / ${rat.hpMax}`;
  }

  // ----- Simple Synth (no external files) -----
  const AC = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AC();
  let unlocked = false;
  window.addEventListener('pointerdown', () => { if (!unlocked) { audioCtx.resume(); unlocked = true; } }, {once:true});

  function squeak() {
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'square';
    o.frequency.setValueAtTime(860, t);
    o.frequency.exponentialRampToValueAtTime(1500, t+0.03);
    g.gain.setValueAtTime(0.12, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.12);
    o.connect(g).connect(audioCtx.destination);
    o.start(t); o.stop(t+0.13);
  }
  function boom() {
    const t = audioCtx.currentTime;
    const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.25, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * (1 - i/data.length); // noise with decay
    const s = audioCtx.createBufferSource(); s.buffer = buf;
    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.5, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.25);
    s.connect(g).connect(audioCtx.destination); s.start(t);
  }

  // ----- Particles / Effects -----
  const particles = [];
  const numbers = [];   // floating damage numbers
  const slashes = [];   // knife slash trails
  let screenShake = 0;

  function addHitSpark(x,y,qty=12,power=3,color='#ffd166'){
    for (let i=0;i<qty;i++){
      const a = Math.random()*Math.PI*2;
      const s = power*(.7 + Math.random()*1.3);
      particles.push({x,y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, life: 16 + (Math.random()*10|0), r: 2+Math.random()*2, col: color});
    }
  }
  function addBloodlessPoof(x,y){
    addHitSpark(x,y,16,2,'#ffe08a');
  }
  function addDamageNumber(x,y,amt){
    numbers.push({x,y,vy:-0.7,life:40,text:`-${amt}`});
  }
  function addSlashPath(path){
    slashes.push({path: path.slice(), life: 16});
  }

  // ----- Bombs -----
  const bombs = [];
  function placeBomb(x,y){
    bombs.push({x,y,t:60}); // ~1s fuse at 60fps
  }

  // ----- Drawing the Cartoon Rat (procedural, no images) -----
  function drawRat(ctx){
    ctx.save();
    ctx.translate(rat.x, rat.y);
    ctx.rotate(rat.rot);

    // Body
    ctx.fillStyle = '#9a9a9a';
    ctx.strokeStyle = '#0009';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(0, 0, 54, 36, 0, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Belly
    ctx.fillStyle = '#c9c9c9';
    ctx.beginPath();
    ctx.ellipse(10, 8, 24, 18, 0.2, 0, Math.PI*2);
    ctx.fill();

    // Head
    ctx.fillStyle = '#9a9a9a';
    ctx.beginPath();
    ctx.ellipse(-50, -10, 28, 24, 0, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Ears
    ctx.fillStyle = '#9a9a9a';
    ctx.beginPath(); ctx.arc(-70,-28,10,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(-55,-30,8,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#ffb3c1';
    ctx.beginPath(); ctx.arc(-70,-28,6,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(-55,-30,5,0,Math.PI*2); ctx.fill();

    // Eye
    ctx.fillStyle = '#111';
    ctx.beginPath(); ctx.arc(-60,-12,3.4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(-58,-13,1.4,0,Math.PI*2); ctx.fill();

    // Nose
    ctx.fillStyle = '#e9718a';
    ctx.beginPath(); ctx.arc(-78,-6,3.6,0,Math.PI*2); ctx.fill();

    // Whiskers
    ctx.strokeStyle = '#eee';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(-72,-6); ctx.lineTo(-88,-12);
    ctx.moveTo(-72,-6); ctx.lineTo(-88,-3);
    ctx.moveTo(-72,-6); ctx.lineTo(-88,6);
    ctx.stroke();

    // Feet
    ctx.strokeStyle = '#0009'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(20,28); ctx.lineTo(36,34);
    ctx.moveTo(-10,28); ctx.lineTo(6,34);
    ctx.stroke();

    // Tail
    ctx.strokeStyle = '#f4a7a7'; ctx.lineWidth = 6; ctx.lineCap='round';
    ctx.beginPath();
    ctx.moveTo(40,-2);
    ctx.bezierCurveTo(70,-4, 90,18, 110,8);
    ctx.stroke();

    // Hurt flash
    if (rat.hurt > 0){
      ctx.globalAlpha = Math.min(0.6, rat.hurt/14);
      ctx.fillStyle = '#ff4d6d';
      ctx.beginPath(); ctx.ellipse(0, 0, 54, 36, 0, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }

    ctx.restore();
  }

  // ----- Physics / Helpers -----
  function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
  function dist2(x1,y1,x2,y2){const dx=x1-x2, dy=y1-y2; return dx*dx+dy*dy;}
  function hitRatPoint(x,y){
    // approximate with circle around body center
    return dist2(x,y, rat.x, rat.y) <= (rat.r*rat.r);
  }
  function damage(amount, knockX=0, knockY=0, spin=0){
    if (rat.hp <= 0) return;
    rat.hp -= amount;
    rat.vx += knockX; rat.vy += knockY; rat.rotV += spin;
    rat.hurt = 14;
    updateHUD();
    addDamageNumber(rat.x, rat.y- rat.r - 10, amount);
    if (rat.hp <= 0){
      showToast('üíÄ The Stoinky rat is Killed! Press Reset to play again.');
    }
  }

  // ----- Input / Weapons -----
  let currentTool = 'punch';
  let slicing = false, slicePath = [];

  const weaponBar = document.getElementById('weapons');
  weaponBar.addEventListener('click', e=>{
    const btn = e.target.closest('.wbtn'); if(!btn) return;
    currentTool = btn.dataset.tool;
    weaponBar.querySelectorAll('.wbtn').forEach(b=>b.dataset.active = (b===btn));
    showToast({
      punch: 'üëä Punch: click the rat.',
      bat:   'ü¶¥ Bat: bigger knockback.',
      knife: 'üó°Ô∏è Knife: hold & drag to slice.',
      bomb:  'üí£ Bomb: click to place (1s fuse).'
    }[currentTool]);
  });

  function canvasPos(evt){
    const r = cvs.getBoundingClientRect();
    return {x: (evt.clientX - r.left), y: (evt.clientY - r.top)};
  }

  cvs.addEventListener('pointerdown', e=>{
    const {x,y} = canvasPos(e);
    if (currentTool === 'knife'){
      slicing = true; slicePath = [{x,y}];
    } else if (currentTool === 'bomb'){
      placeBomb(x,y);
    } else {
      // punch / bat
      if (hitRatPoint(x,y)){
        const amt = currentTool==='bat' ? 20 : 10;
        const power = currentTool==='bat' ? 9 : 5.5;
        const dx = (rat.x - x), dy = (rat.y - y);
        const n = Math.hypot(dx,dy) || 1;
        damage(amt, (dx/n)*power, (dy/n)*power, (Math.random()-.5)*(currentTool==='bat'?0.25:0.18));
        addBloodlessPoof(x,y);
        screenShake = Math.min(14, screenShake + (currentTool==='bat'?8:5));
        squeak();
      }
    }
  });
  cvs.addEventListener('pointermove', e=>{
    if (!slicing) return;
    const p = canvasPos(e);
    const lp = slicePath[slicePath.length-1];
    const dx=p.x-lp.x, dy=p.y-lp.y;
    if (dx*dx+dy*dy > 10) slicePath.push(p); // resample path
  });
  function segmentHitsRat(a,b){
    // distance from segment AB to rat center <= rat.r
    const rx=rat.x, ry=rat.y;
    const vx=b.x-a.x, vy=b.y-a.y;
    const wx=rx-a.x, wy=ry-a.y;
    const c1 = vx*wx+vy*wy;
    const c2 = vx*vx+vy*vy || 1;
    let t = clamp(c1/c2, 0, 1);
    const px = a.x + t*vx, py = a.y + t*vy;
    return dist2(px,py,rx,ry) <= rat.r*rat.r;
  }
  window.addEventListener('pointerup', e=>{
    if (!slicing) return;
    slicing = false;
    addSlashPath(slicePath);
    // Evaluate damage based on any segment intersecting body
    let hit = false, length=0;
    for (let i=1;i<slicePath.length;i++){
      const a=slicePath[i-1], b=slicePath[i];
      length += Math.hypot(b.x-a.x, b.y-a.y);
      if (segmentHitsRat(a,b)) hit = true;
    }
    if (hit){
      const amt = clamp(Math.round(6 + length*0.06), 8, 30);
      const dir = slicePath.length>1 ? slicePath[slicePath.length-1] : slicePath[0];
      const dx = rat.x - dir.x, dy = rat.y - dir.y;
      const n = Math.hypot(dx,dy)||1;
      damage(amt, (dx/n)*7, (dy/n)*7, (Math.random()-.5)*0.35);
      addHitSpark(rat.x, rat.y, 18, 3.4, '#fffbd1');
      screenShake = Math.min(16, screenShake + 9);
      squeak();
    }
    slicePath = [];
  });

  // ----- Reset -----
  document.getElementById('reset').addEventListener('click', centerRat);

  // ----- Toast -----
  const toast = document.getElementById('toast');
  let toastTimer = 0;
  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.style.display='none', 1600);
  }

  // ----- Main Loop -----
  let last = performance.now();
  function tick(now){
    const dt = Math.min(33, now-last); last = now;

    // Physics
    rat.vy += 0.25; // gravity
    rat.x += rat.vx; rat.y += rat.vy; rat.rot += rat.rotV;
    rat.vx *= 0.985; rat.vy *= 0.985; rat.rotV *= 0.985;
    rat.hurt = Math.max(0, rat.hurt - 1);

    // Walls
    const w=W(), h=H();
    const bounce=0.55;
    if (rat.x - rat.r < 8){ rat.x = 8 + rat.r; rat.vx = Math.abs(rat.vx)*bounce; }
    if (rat.x + rat.r > w-8){ rat.x = w-8 - rat.r; rat.vx = -Math.abs(rat.vx)*bounce; }
    if (rat.y - rat.r < 8){ rat.y = 8 + rat.r; rat.vy = Math.abs(rat.vy)*bounce; }
    if (rat.y + rat.r > h-8){ rat.y = h-8 - rat.r; rat.vy = -Math.abs(rat.vy)*bounce; }

    // Bombs
    for (let i=bombs.length-1;i>=0;i--){
      const b = bombs[i]; b.t--;
      if (b.t<=0){
        // explode
        const R = 120;
        const d = Math.hypot(rat.x-b.x, rat.y-b.y);
        if (d < R+rat.r){
          const power = (1 - d/(R+rat.r)) * 18;
          const dx = rat.x - b.x, dy = rat.y - b.y;
          const n = Math.hypot(dx,dy)||1;
          damage(28 + Math.round(power*2), (dx/n)*power, (dy/n)*power, (Math.random()-.5)*0.5);
          screenShake = Math.max(screenShake, 18);
          addHitSpark(b.x,b.y,48,5,'#fff1a8');
          boom();
        }
        b.exploded = true; b.life = 22;
        bombs.splice(i,1);
        // leave a transient explosion ring as particles (handled by particles array already)
      }
    }

    // Particles
    for (let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.vx *= 0.99; p.vy *= 0.99;
      p.life--; if (p.life<=0) particles.splice(i,1);
    }
    // Damage numbers
    for (let i=numbers.length-1;i>=0;i--){
      const n=numbers[i]; n.y += n.vy; n.vy *= 0.96; n.life--;
      if (n.life<=0) numbers.splice(i,1);
    }
    // Slash trails
    for (let i=slashes.length-1;i>=0;i--){
      slashes[i].life--; if (slashes[i].life<=0) slashes.splice(i,1);
    }

    // ----- Render -----
    ctx.save();

    // Screen shake
    if (screenShake>0){
      screenShake *= 0.9;
      ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake);
    }

    // Background grid
    const wcell=40, hcell=40;
    ctx.fillStyle='#3c3c3c'; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#0005'; ctx.lineWidth=1;
    ctx.beginPath();
    for(let x=10;x<w;x+=wcell){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
    for(let y=10;y<h;y+=hcell){ ctx.moveTo(0,y); ctx.lineTo(w,y); }
    ctx.stroke();

    // Bomb fuses (draw bombs as little black balls with fuse)
    for (const b of bombs){
      ctx.save();
      ctx.translate(b.x,b.y);
      ctx.fillStyle='#222'; ctx.strokeStyle='#fff9'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill(); ctx.stroke();
      // fuse
      ctx.strokeStyle='#ffcf33'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(6,-6); ctx.quadraticCurveTo(14,-16, 20,-10); ctx.stroke();
      // spark
      ctx.fillStyle='#ffd166';
      ctx.beginPath(); ctx.arc(20,-10, 3+Math.random()*1.5, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }

    // Rat
    if (rat.hp>0) drawRat(ctx);

    // Particles
    for(const p of particles){
      ctx.globalAlpha = Math.max(0, p.life/22);
      ctx.fillStyle = p.col||'#ffd166';
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    }

    // Slash trails
    for(const s of slashes){
      ctx.strokeStyle = `rgba(255,255,255,${s.life/16})`;
      ctx.lineWidth = 4;
      ctx.lineJoin = 'round'; ctx.lineCap = 'round';
      ctx.beginPath();
      for (let i=0;i<s.path.length;i++){
        const p=s.path[i];
        if (i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
      }
      ctx.stroke();
    }

    // Damage numbers
    ctx.font='bold 18px ui-sans-serif, system-ui, Arial';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    for (const n of numbers){
      ctx.fillStyle=`rgba(255,255,255,${n.life/40})`;
      ctx.fillText(n.text, n.x, n.y);
    }

    // Death banner
    if (rat.hp<=0){
      ctx.fillStyle='rgba(0,0,0,.45)';
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle='#fff';
      ctx.font='900 34px system-ui, Arial';
      ctx.textAlign='center';
      ctx.fillText('üíÄ The Stoinky Rat is Killed! üíÄ', w/2, h/2 - 6);
      ctx.font='600 16px system-ui, Arial';
      ctx.fillText('Press Reset to play again', w/2, h/2 + 20);
    }

    ctx.restore();
    requestAnimationFrame(tick);
  }

  centerRat();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
